<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>phonopi</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
</head>
<body>
<div class="container" >

    <h1>phonopi</h1>

<div class="accordion" id="accordionExample">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                <i class="bi bi-vinyl-fill"></i> &nbsp;
                Vinyl
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
            <div class="accordion-body">
                <center >
                    <p id="phono_connecting">
                        Connecting...
                    </p>
                </center>
                <div class="d-flex justify-content-center" >
                    <div style="display: none; padding: 5px;" id="phono_stream_container">
                        <h4 style="text-align: center;">
                            Listen</h4>
                        <p>
                            <audio controls src="http://phonopi:8000/phono.mp3"
                                   type="audio/mpeg"
                                   id="phono_stream_player" ></audio>

                        </p>
                        <center>
                           <button type="button" class="btn btn-danger" id="btnStartRec" onclick="toggleRecording()">
                               <i class="bi bi-record-fill"></i> &nbsp;
                               Start Recording to MP3
                           </button>

                            <button type="button" class="btn btn-danger" id="btnStopRec" onclick="toggleRecording()">
                                <i class="bi bi-stop-circle"></i> &nbsp;
                               Stop Recording
                           </button>
                        </center>
                    </div>


                    <div class="alert alert-warning" role="alert" style="display: none;" id="no_stream">
                        <h4 style="text-align: center;">
                            <i class="bi bi-exclamation-diamond-fill"></i>
                            No Stream
                        </h4>
                        <p>
                            The record player does not seem to be streaming right now.  Please make sure
                            that the record player and amp are on, the volume is up above 3, and the
                            headphone cable is plugged in.
                        </p>
                    </div>

                    <div>

                    </div>
                </div>

                <center>
                    <a class="btn btn-info" role="button" href="/butt/manage_recordings">
                        Manage Recordings
                    </a>
                </center>



            </div>
        </div>
    </div>



    <div class="accordion-item">
        <h2 class="accordion-header" id="headingTwo">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                <i class="bi bi-file-earmark-music-fill"></i> &nbsp;
                MP3
            </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
            <div class="accordion-body">
                <center>
                    <a class="btn btn-primary" href="/vlc" role="button">
                        <i class="bi bi-volume-up-fill"></i> &nbsp;
                        Open MP3 Control
                    </a>
                    <p style="font-style: italic">
                        Password: 1238 (no username)
                    </p>
                </center>
            </div>
        </div>
    </div>



    <div class="accordion-item">
        <h2 class="accordion-header" id="headingThree">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                <i class="bi bi-music-player-fill"></i> &nbsp;
                Spotify
            </button>
        </h2>
        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
            <div class="accordion-body">
                <strong>Spotify Enabled Device.</strong>
                This device is discoverable by Spottify using the Spottify Connect protocol.  On your phone, simply
                opent he Spotify app, go to Settings, then Devices, then look for <code>phonopi</code>.
                You should then be able to control which songs are played.
            </div>
        </div>
    </div>


    <div class="accordion-item">
        <h2 class="accordion-header" id="heading4">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse4" aria-expanded="false" aria-controls="collapse4">
                <i class="bi bi-hdd-stack-fill"></i> &nbsp;
                Status
            </button>
        </h2>
        <div id="collapse4" class="accordion-collapse collapse" aria-labelledby="heading4" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <h3>IceCast</h3>
                <p><a class="btn btn-primary" href="http://phonopi:8000" role="button">Icecast home</a></p>
                <p><a class="btn btn-primary" href="http://phonopi:8000/phono" role="button">Listen to vinyl!</a></p>
              <h3>Butt</h3>
                Alive: {{ butt.alive }} <br/>
                Streaming: {{ butt.connected }} <br/>
                Recording: {{ butt.recording }} <br/>

              <h3>VLC</h3>
                Alive: {{ vlc }}

            </div>
        </div>
    </div>
</div>
</div>





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


<script>
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Handle display of phono video element
var videoElem = document.getElementById('phono_stream_player');
var wasStreaming = false;

function checkPhonoPlayer(){

    $.ajax({
        url: '/butt/streaming',
        success: function(data){
            console.log(`Streaming: ${data}`);
            if (data == "False"){
                // Not streaming
                document.getElementById('phono_stream_container').style.display = 'none';
                document.getElementById('no_stream').style.display = 'block';
                $("#phono_connecting").hide();
                wasStreaming = false;

                // Recheck 1 one second
                setTimeout(checkPhonoPlayer, 1000);
            }else{
                // Stream active
                document.getElementById('phono_stream_container').style.display = 'block';
                document.getElementById('no_stream').style.display = 'none';
                $("#phono_connecting").hide();

                if (!wasStreaming){
                    // Reload
                    videoElem.load();
                    wasStreaming = true;
                }


                // Recheck every 5 seconds to make sure we're still alive.
                setTimeout(checkPhonoPlayer, 5000);
            }
        },
        error: function(xhr,status,err){
            // Try again in a little bit
            setTimeout(checkPhonoPlayer, 222);
        }
    });
}

setTimeout(checkPhonoPlayer, 50);


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Handle record button
function updateRecordButton(){
    if (document.getElementById('phono_stream_container').style.display == 'none'){
        // noop.  Stream not active
        return;
    }
    $.ajax({
        url: '/butt/recording',
        success: function(data){
            console.log(`Recording: ${data}`);
            if (data == "False"){
                $("#btnStopRec").hide();
                $("#btnStartRec").show();
            }else{
                $("#btnStopRec").show();
                $("#btnStartRec").hide();
            }
        }
    });

}
$("#btnStopRec").hide();
setInterval(updateRecordButton, 5000);

function toggleRecording(){
    $("#btnStartRec").prop("disabled", true);
    $("#btnStopRec").prop("disabled", true);

    $.ajax({
        url: '/butt/recording',
        method: 'POST',
        success: function(data){
            console.log(`After toggle: ${data}`);
            if (data == "False"){
                $("#btnStopRec").hide();
                $("#btnStartRec").show();
            }else{
                $("#btnStopRec").show();
                $("#btnStartRec").hide();
            }
            $("#btnStartRec").prop("disabled", false);
            $("#btnStopRec").prop("disabled", false);
        }
    });
}

</script>

</body>
</html>